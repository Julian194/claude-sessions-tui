name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  go-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Run tests
        run: go test ./... -v

      - name: Run tests with coverage
        run: |
          # Run coverage only on packages with tests (excludes adapters, preview)
          go test -coverprofile=coverage.out \
            ./internal/adapters/claude/... \
            ./internal/adapters/opencode/... \
            ./internal/cache/... \
            ./internal/export/... \
            ./internal/stats/... \
            ./internal/tui/...

      - name: Check coverage threshold
        run: |
          total=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Total coverage: ${total}%"
          if (( $(echo "$total < 70" | bc -l) )); then
            echo "Coverage below 70%"
            exit 1
          fi
          echo "Coverage OK"

  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build
        run: go build -o sessions ./cmd/sessions

      - name: Test binary runs
        run: ./sessions help

  integration-tests:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build binary
        run: go build -o sessions ./cmd/sessions

      - name: Check dependencies available
        run: |
          brew install fzf jq
          command -v fzf && echo "fzf OK"
          command -v jq && echo "jq OK"

      - name: Test rebuild with no sessions
        run: |
          export CLAUDE_DIR=$(mktemp -d)
          mkdir -p "$CLAUDE_DIR/projects"
          ./sessions rebuild || true
          echo "rebuild completed"

      - name: Test preview with mock session
        run: |
          export CLAUDE_DIR=$(mktemp -d)
          mkdir -p "$CLAUDE_DIR/projects/test-project"
          echo '{"type":"summary","summary":"Test session summary"}' > "$CLAUDE_DIR/projects/test-project/abc12345-1234-1234-1234-123456789abc.jsonl"
          echo '{"cwd":"/test/dir","gitBranch":"main"}' >> "$CLAUDE_DIR/projects/test-project/abc12345-1234-1234-1234-123456789abc.jsonl"
          output=$(./sessions preview abc12345-1234-1234-1234-123456789abc 2>&1)
          if echo "$output" | grep -q "test-project"; then
            echo "preview shows project name"
          else
            echo "preview output incorrect: $output"
            exit 1
          fi

      - name: Test stats with mock session
        run: |
          export CLAUDE_DIR=$(mktemp -d)
          mkdir -p "$CLAUDE_DIR/projects/test-project"
          echo '{"type":"user","message":{"role":"user","content":"Hello"}}' > "$CLAUDE_DIR/projects/test-project/test-session.jsonl"
          echo '{"type":"assistant","message":{"role":"assistant","content":"Hi","usage":{"input_tokens":10,"output_tokens":5}}}' >> "$CLAUDE_DIR/projects/test-project/test-session.jsonl"
          output=$(./sessions stats test-session 2>&1)
          if echo "$output" | grep -qi "token\|message"; then
            echo "stats shows token/message info"
          else
            echo "stats output incorrect: $output"
            exit 1
          fi

      - name: Fish syntax check
        run: |
          brew install fish
          fish -n scripts/test-pr && echo "scripts/test-pr OK"

      - name: Homebrew formula audit
        run: |
          brew audit --formula Formula/claude-sessions.rb || true
          echo "formula checked"
