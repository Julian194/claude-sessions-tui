#!/usr/bin/env bash
# Tests for claude-sessions-rebuild pipeline
# Note: Not using set -e because grep returns 1 when no match found

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TEST_DIR=$(mktemp -d)
trap 'rm -rf "$TEST_DIR"' EXIT

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

PASSED=0
FAILED=0

pass() {
  echo -e "${GREEN}✓${NC} $1"
  ((PASSED++))
}

fail() {
  echo -e "${RED}✗${NC} $1"
  echo "  Expected: $2"
  echo "  Got:      $3"
  ((FAILED++))
}

# Setup test environment
export CLAUDE_DIR="$TEST_DIR"
mkdir -p "$TEST_DIR/projects/test-project"

# Create mock session files with specific dates
create_session() {
  local sid="$1"
  local date="$2"  # YYYY-MM-DD
  local summary="$3"
  local parent="$4"
  local file="$TEST_DIR/projects/test-project/${sid}.jsonl"

  if [ -n "$parent" ]; then
    echo "{\"parentSession\":\"$parent\",\"summary\":\"$summary\"}" > "$file"
  elif [ -n "$summary" ]; then
    echo "{\"summary\":\"$summary\"}" > "$file"
  else
    echo "{}" > "$file"
  fi

  # Set file modification time
  if [[ "$OSTYPE" == "darwin"* ]]; then
    touch -t "$(echo "$date" | sed 's/-//g')1200" "$file"
  else
    touch -d "$date 12:00:00" "$file"
  fi
}

echo "=== Testing Date Separator Placement ==="

# Test 1: Headers appear after sessions (for correct display order)
create_session "session-dec18" "2025-12-18" "Session on Dec 18"
create_session "session-dec17" "2025-12-17" "Session on Dec 17"
create_session "session-dec16" "2025-12-16" "Session on Dec 16"

# Clear cache to force full rebuild
rm -f "$TEST_DIR/sessions-cache.tsv"

OUTPUT=$("$SCRIPT_DIR/claude-sessions-rebuild" 2>/dev/null)

# Check that each date's sessions come BEFORE their header (for display)
# In the output: sessions first, then header for that date
dec18_session_line=$(echo "$OUTPUT" | grep -n "session-dec18" | head -1 | cut -d: -f1)
dec18_header_line=$(echo "$OUTPUT" | grep -n "December 18, 2025" | cut -d: -f1)

if [ -n "$dec18_session_line" ] && [ -n "$dec18_header_line" ] && [ "$dec18_session_line" -lt "$dec18_header_line" ]; then
  pass "Dec 18 sessions appear before Dec 18 header"
else
  fail "Dec 18 sessions should appear before header" "session < header" "session=$dec18_session_line, header=$dec18_header_line"
fi

dec17_session_line=$(echo "$OUTPUT" | grep -n "session-dec17" | head -1 | cut -d: -f1)
dec17_header_line=$(echo "$OUTPUT" | grep -n "December 17, 2025" | cut -d: -f1)

if [ -n "$dec17_session_line" ] && [ -n "$dec17_header_line" ] && [ "$dec17_session_line" -lt "$dec17_header_line" ]; then
  pass "Dec 17 sessions appear before Dec 17 header"
else
  fail "Dec 17 sessions should appear before header" "session < header" "session=$dec17_session_line, header=$dec17_header_line"
fi

# Test 2: Headers match their sessions' dates
dec18_count=$(echo "$OUTPUT" | sed -n "1,${dec18_header_line}p" | grep -c "12-18" || true)
if [ "$dec18_count" -ge 1 ]; then
  pass "Dec 18 header groups 12-18 sessions"
else
  fail "Dec 18 header should group 12-18 sessions" ">=1" "$dec18_count"
fi

echo ""
echo "=== Testing Branch Grouping ==="

# Test 3: Branches appear under their parent
rm -rf "$TEST_DIR/projects"
mkdir -p "$TEST_DIR/projects/test-project"
rm -f "$TEST_DIR/sessions-cache.tsv"

create_session "parent-session" "2025-12-18" "Parent session"
create_session "branch-session" "2025-12-18" "Branch session" "parent-session"

OUTPUT=$("$SCRIPT_DIR/claude-sessions-rebuild" 2>/dev/null)

parent_line=$(echo "$OUTPUT" | grep -n "parent-session" | grep -v "└─" | head -1 | cut -d: -f1)
branch_line=$(echo "$OUTPUT" | grep -n "branch-session" | head -1 | cut -d: -f1)

if [ -n "$parent_line" ] && [ -n "$branch_line" ] && [ "$branch_line" -gt "$parent_line" ]; then
  pass "Branch appears after parent"
else
  fail "Branch should appear after parent" "branch > parent" "parent=$parent_line, branch=$branch_line"
fi

# Test 4: Branch has visual indicator
if echo "$OUTPUT" | grep -q "└─.*branch-session\|branch-session.*└─"; then
  pass "Branch has └─ visual indicator"
else
  # Check if branch line contains the indicator somewhere
  branch_output=$(echo "$OUTPUT" | grep "branch-session")
  if echo "$branch_output" | grep -q "└─"; then
    pass "Branch has └─ visual indicator"
  else
    fail "Branch should have └─ indicator" "└─" "$branch_output"
  fi
fi

echo ""
echo "=== Testing Multi-Day with Branches ==="

# Test 5: Branch inherits parent's date group (doesn't create new header)
rm -rf "$TEST_DIR/projects"
mkdir -p "$TEST_DIR/projects/test-project"
rm -f "$TEST_DIR/sessions-cache.tsv"

create_session "day1-parent" "2025-12-17" "Day 1 parent"
create_session "day2-parent" "2025-12-18" "Day 2 parent"
create_session "day2-branch" "2025-12-18" "Day 2 branch" "day2-parent"

OUTPUT=$("$SCRIPT_DIR/claude-sessions-rebuild" 2>/dev/null)

# Count headers - should be exactly 2 (one per day)
header_count=$(echo "$OUTPUT" | grep -c -F -- "---HEADER---" || true)
if [ "$header_count" -eq 2 ]; then
  pass "Exactly 2 date headers for 2 different days"
else
  fail "Should have exactly 2 headers" "2" "$header_count"
fi

echo ""
echo "=== Testing Output Format ==="

# Test 6: Output has correct number of columns (7 fields)
rm -rf "$TEST_DIR/projects"
mkdir -p "$TEST_DIR/projects/test-project"
rm -f "$TEST_DIR/sessions-cache.tsv"

create_session "test-session" "2025-12-18" "Test summary"

OUTPUT=$("$SCRIPT_DIR/claude-sessions-rebuild" 2>/dev/null)
session_line=$(echo "$OUTPUT" | grep "test-session" | head -1)
col_count=$(echo "$session_line" | awk -F'\t' '{print NF}')

if [ "$col_count" -eq 7 ]; then
  pass "Session line has 7 tab-separated columns"
else
  fail "Session should have 7 columns" "7" "$col_count"
fi

# Test 7: Header line is not selectable (has ---HEADER--- marker)
header_line=$(echo "$OUTPUT" | grep -F -- "---HEADER---" | head -1)
if [ -n "$header_line" ]; then
  pass "Header lines have ---HEADER--- marker"
else
  fail "Headers should have ---HEADER--- marker" "---HEADER---" "(not found)"
fi

echo ""
echo "=== Testing Empty/Edge Cases ==="

# Test 8: Empty project directory
rm -rf "$TEST_DIR/projects"
mkdir -p "$TEST_DIR/projects/test-project"
rm -f "$TEST_DIR/sessions-cache.tsv"

OUTPUT=$("$SCRIPT_DIR/claude-sessions-rebuild" 2>/dev/null || true)
if [ -z "$OUTPUT" ]; then
  pass "Empty directory produces no output"
else
  fail "Empty directory should produce no output" "(empty)" "$OUTPUT"
fi

# Test 9: Session without summary
rm -rf "$TEST_DIR/projects"
mkdir -p "$TEST_DIR/projects/test-project"
rm -f "$TEST_DIR/sessions-cache.tsv"

create_session "no-summary" "2025-12-18" ""

OUTPUT=$("$SCRIPT_DIR/claude-sessions-rebuild" 2>/dev/null)
if echo "$OUTPUT" | grep -q "no-summary"; then
  pass "Session without summary is included"
else
  fail "Session without summary should be included" "no-summary" "(not found)"
fi

echo ""
echo "=== Testing Sort Order ==="

# Test 10: Sessions sorted by mtime (newest first)
rm -rf "$TEST_DIR/projects"
mkdir -p "$TEST_DIR/projects/test-project"
rm -f "$TEST_DIR/sessions-cache.tsv"

create_session "older-session" "2025-12-17" "Older"
sleep 1
create_session "newer-session" "2025-12-18" "Newer"

OUTPUT=$("$SCRIPT_DIR/claude-sessions-rebuild" 2>/dev/null)

newer_line=$(echo "$OUTPUT" | grep -n "newer-session" | head -1 | cut -d: -f1)
older_line=$(echo "$OUTPUT" | grep -n "older-session" | head -1 | cut -d: -f1)

if [ -n "$newer_line" ] && [ -n "$older_line" ] && [ "$newer_line" -lt "$older_line" ]; then
  pass "Newer sessions appear before older sessions"
else
  fail "Newer sessions should appear first" "newer < older" "newer=$newer_line, older=$older_line"
fi

echo ""
echo "=== Testing Cache Functionality ==="

# Test 11: Cache file is created
rm -rf "$TEST_DIR/projects"
mkdir -p "$TEST_DIR/projects/test-project"
rm -f "$TEST_DIR/sessions-cache.tsv"

create_session "cache-test" "2025-12-18" "Cache test"

"$SCRIPT_DIR/claude-sessions-rebuild" > /dev/null 2>&1

if [ -f "$TEST_DIR/sessions-cache.tsv" ]; then
  pass "Cache file is created"
else
  fail "Cache file should be created" "exists" "(not found)"
fi

# Test 12: Cache has correct format (7 columns)
if [ -f "$TEST_DIR/sessions-cache.tsv" ]; then
  cache_cols=$(head -1 "$TEST_DIR/sessions-cache.tsv" | awk -F'\t' '{print NF}')
  if [ "$cache_cols" -eq 7 ]; then
    pass "Cache file has 7 columns"
  else
    fail "Cache should have 7 columns" "7" "$cache_cols"
  fi
fi

# Test 13: Incremental update works
# Create a new session file that is newer than the cache
sleep 1
new_file="$TEST_DIR/projects/test-project/incremental-test.jsonl"
echo '{"summary":"Incremental"}' > "$new_file"
# Touch with current time (will be newer than cache)
touch "$new_file"

OUTPUT=$("$SCRIPT_DIR/claude-sessions-rebuild" 2>/dev/null)

if echo "$OUTPUT" | grep -q "incremental-test"; then
  pass "Incremental update includes new session"
else
  fail "Incremental update should include new session" "incremental-test" "(not found)"
fi

echo ""
echo "=== Testing Date Header Content ==="

# Test 14: Header contains weekday name
rm -rf "$TEST_DIR/projects"
mkdir -p "$TEST_DIR/projects/test-project"
rm -f "$TEST_DIR/sessions-cache.tsv"

create_session "weekday-test" "2025-12-18" "Weekday test"

OUTPUT=$("$SCRIPT_DIR/claude-sessions-rebuild" 2>/dev/null)

if echo "$OUTPUT" | grep -q "Thursday"; then
  pass "Header contains weekday name (Thursday)"
else
  fail "Header should contain weekday" "Thursday" "$(echo "$OUTPUT" | grep -F -- '---HEADER---')"
fi

# Test 15: Header contains full month name
if echo "$OUTPUT" | grep -q "December"; then
  pass "Header contains full month name"
else
  fail "Header should contain month name" "December" "(not found)"
fi

echo ""
echo "=== Testing Agent Session Filtering ==="

# Test 16: Agent sessions are excluded
rm -rf "$TEST_DIR/projects"
mkdir -p "$TEST_DIR/projects/test-project"
rm -f "$TEST_DIR/sessions-cache.tsv"

create_session "normal-session" "2025-12-18" "Normal"
create_session "agent-12345" "2025-12-18" "Agent session"

OUTPUT=$("$SCRIPT_DIR/claude-sessions-rebuild" 2>/dev/null)

if echo "$OUTPUT" | grep -q "normal-session" && ! echo "$OUTPUT" | grep -q "agent-12345"; then
  pass "Agent sessions are filtered out"
else
  fail "Agent sessions should be excluded" "normal only" "$(echo "$OUTPUT" | grep -E 'normal|agent')"
fi

echo ""
echo "========================================"
echo -e "Results: ${GREEN}$PASSED passed${NC}, ${RED}$FAILED failed${NC}"
echo "========================================"

exit $FAILED
