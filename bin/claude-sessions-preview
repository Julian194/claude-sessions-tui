#!/usr/bin/env bash
set -e

CLAUDE_DIR="${CLAUDE_DIR:-$HOME/.claude}"

sid="$1"
f=$(find "$CLAUDE_DIR/projects" -name "${sid}.jsonl" 2>/dev/null | head -1)
[ -z "$f" ] && exit 0

# Project and date - cross-platform
proj=$(basename "$(dirname "$f")" | sed 's/-Users-[^-]*-code-//')
if [[ "$OSTYPE" == "darwin"* ]]; then
  date=$(stat -f '%Sm' -t '%Y-%m-%d %H:%M' "$f")
else
  date=$(date -r "$f" '+%Y-%m-%d %H:%M')
fi
branch=$(grep -o '"gitBranch":"[^"]*"' "$f" 2>/dev/null | head -1 | sed 's/"gitBranch":"//g;s/"$//g')

echo "ğŸ”‘ $sid"
echo "ğŸ“ $proj"
echo "ğŸ“… $date"
[ -n "$branch" ] && echo "ğŸŒ¿ $branch"
echo ""

# Summaries
summaries=$(grep -o '"summary":"[^"]*"' "$f" 2>/dev/null | sed 's/"summary":"//g;s/"$//g')
if [ -n "$summaries" ]; then
  echo "â”â”â” Topics â”â”â”"
  echo "$summaries" | while read -r s; do
    echo "â€¢ $s"
  done
  echo ""
fi

# Slash Commands (from both command-name tags and SlashCommand tool calls)
slash_commands=$(
  {
    grep -o '<command-name>/[^<]*</command-name>' "$f" 2>/dev/null | sed 's|<command-name>||g;s|</command-name>||g'
    grep -o '"name":"SlashCommand"[^}]*"command":"[^"]*"' "$f" 2>/dev/null | sed 's/.*"command":"//g;s/".*//g'
  } | sort -u
)
if [ -n "$slash_commands" ]; then
  echo "â”â”â” Slash Commands â”â”â”"
  echo "$slash_commands" | while read -r cmd; do
    echo "  $cmd"
  done
  echo ""
fi

# Files touched (from Write/Edit tool calls) - show path relative to project
cwd=$(grep -o '"cwd":"[^"]*"' "$f" 2>/dev/null | head -1 | sed 's/"cwd":"//g;s/"$//g')
files=$(grep -o '"file_path":"[^"]*"' "$f" 2>/dev/null | \
  sed 's/"file_path":"//g;s/"$//g' | \
  sort -u | \
  sed "s|$cwd/||" | \
  head -10)
if [ -n "$files" ]; then
  echo "â”â”â” Files â”â”â”"
  echo "$files" | while read -r p; do
    echo "â€¢ $p"
  done
  echo ""
fi

# Stats
claude-sessions-stats "$sid" 2>/dev/null
echo ""

# If no topics, show first user message
if [ -z "$summaries" ]; then
  echo "â”â”â” First Message â”â”â”"
  grep -o '"role":"user","content":"[^"]*"' "$f" 2>/dev/null | \
    head -1 | \
    sed 's/"role":"user","content":"//g;s/"$//g;s/\\n/ /g' | \
    cut -c1-200
fi
