#!/usr/bin/env bash
set -e

CLAUDE_DIR="${CLAUDE_DIR:-$HOME/.claude}"
sid="$1"

# Find session file
f=$(find "$CLAUDE_DIR/projects" -name "${sid}.jsonl" 2>/dev/null | head -1)
[ -z "$f" ] && { echo "Session not found"; exit 1; }

# Extract metadata
proj=$(basename "$(dirname "$f")" | sed 's/-Users-[^-]*-code-//')
branch=$(grep -o '"gitBranch":"[^"]*"' "$f" 2>/dev/null | head -1 | sed 's/"gitBranch":"//;s/"$//')

# Date format: macOS vs Linux
if [[ "$OSTYPE" == "darwin"* ]]; then
  fdate=$(stat -f '%Sm' -t '%Y-%m-%d' "$f" 2>/dev/null)
else
  fdate=$(stat -c '%y' "$f" 2>/dev/null | cut -d' ' -f1)
fi

# Generate LLM-optimized markdown with Python
md=$(python3 << PYEOF
import json
import re

print(f"# Session: $proj ($branch) - $fdate")
print()

# Track last slash command for associating isMeta content
last_slash_command = None

with open("$f") as fp:
    for line in fp:
        try:
            data = json.loads(line)

            # Summary
            if data.get("type") == "summary":
                summary = data.get("summary", "")
                if summary:
                    print("## Summary")
                    print(summary)
                    print()
                continue

            msg = data.get("message", {})
            role = msg.get("role")
            content = msg.get("content")
            is_meta = data.get("isMeta", False)

            # User message
            if role == "user":
                # Handle string content
                if isinstance(content, str):
                    # Skip Caveat messages
                    if content.startswith("Caveat:"):
                        continue

                    # Check for slash command invocation with optional args
                    cmd_match = re.search(r'<command-name>(/[^<]+)</command-name>', content)
                    args_match = re.search(r'<command-args>(.*?)</command-args>', content, re.DOTALL)
                    if cmd_match:
                        cmd_name = cmd_match.group(1)
                        cmd_args = args_match.group(1).strip() if args_match else ""
                        if cmd_args:
                            # Command has args - show it directly
                            print(f"## SlashCommand: {cmd_name}")
                            print(cmd_args)
                            print()
                        else:
                            # Command without args - track for isMeta expansion
                            last_slash_command = cmd_name
                        continue

                    # Skip other XML-tagged system messages
                    if content.startswith("<"):
                        continue

                    print("## User")
                    print(content)
                    print()

                # Handle list content (may contain isMeta expanded prompts)
                elif isinstance(content, list) and is_meta:
                    for item in content:
                        if isinstance(item, dict) and item.get("type") == "text":
                            text = item.get("text", "").strip()
                            if text and last_slash_command:
                                print(f"## SlashCommand: {last_slash_command}")
                                print(text)
                                print()
                                last_slash_command = None

            # Assistant message
            elif role == "assistant" and isinstance(content, list):
                texts = []
                tools = []
                for item in content:
                    if isinstance(item, dict):
                        if item.get("type") == "text":
                            text = item.get("text", "").strip()
                            if text:
                                texts.append(text)
                        elif item.get("type") == "tool_use":
                            name = item.get("name", "tool")
                            inp = item.get("input", {})
                            # Track SlashCommand tool calls
                            if name == "SlashCommand":
                                cmd = inp.get("command", "")
                                if cmd:
                                    last_slash_command = cmd
                                    tools.append(f"[SlashCommand: {cmd}]")
                            else:
                                # Extract display info based on tool type
                                display = ""
                                if inp.get("file_path"):
                                    display = inp["file_path"]
                                elif inp.get("skill"):
                                    display = inp["skill"]
                                elif inp.get("command"):
                                    display = inp["command"]
                                elif inp.get("pattern"):
                                    path = inp.get("path", "")
                                    display = f"{inp['pattern']} in {path}" if path else inp["pattern"]
                                elif inp.get("query"):
                                    display = inp["query"]
                                elif inp.get("url"):
                                    display = inp["url"]
                                elif inp.get("prompt") and inp.get("subagent_type"):
                                    desc = inp.get("description", "")
                                    display = f"[{inp['subagent_type']}] {desc or inp['prompt']}"
                                elif inp.get("todos"):
                                    todos = inp["todos"]
                                    if isinstance(todos, list):
                                        items = [t.get("content", "") for t in todos if isinstance(t, dict)]
                                        display = "; ".join(items)
                                elif inp.get("task_id"):
                                    display = inp["task_id"]
                                elif inp.get("shell_id"):
                                    display = inp["shell_id"]
                                elif inp.get("questions"):
                                    qs = inp["questions"]
                                    if isinstance(qs, list) and qs:
                                        display = qs[0].get("question", "") if isinstance(qs[0], dict) else str(qs[0])
                                elif name.startswith("mcp__"):
                                    for k, v in inp.items():
                                        if isinstance(v, str) and v:
                                            display = f"{k}: {v}"
                                            break
                                else:
                                    for k, v in inp.items():
                                        if isinstance(v, str) and v and k != "description":
                                            display = v
                                            break

                                if display:
                                    tools.append(f"[Tool: {name} {display}]")
                                else:
                                    tools.append(f"[Tool: {name}]")

                if texts or tools:
                    print("## Assistant")
                    if texts:
                        print("\n".join(texts))
                    if tools:
                        print()
                        print(" ".join(tools))
                    print()
        except:
            continue
PYEOF
)

# Copy to clipboard
if [[ "$OSTYPE" == "darwin"* ]]; then
    echo "$md" | pbcopy
else
    echo "$md" | xclip -selection clipboard 2>/dev/null || echo "$md" | xsel --clipboard 2>/dev/null
fi

# Output line count
lines=$(echo "$md" | wc -l | tr -d ' ')
echo "Copied to clipboard ($lines lines)"
