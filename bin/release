#!/usr/bin/env bash
set -e

cd "$(dirname "$0")/.."

# Get current version from formula
current=$(grep 'version "' Formula/claude-sessions.rb | sed 's/.*version "//;s/".*//')
echo "Current version: $current"

# Parse version parts
IFS='.' read -r major minor patch <<< "$current"

# Bump patch by default, or accept argument
case "${1:-patch}" in
  major) major=$((major + 1)); minor=0; patch=0 ;;
  minor) minor=$((minor + 1)); patch=0 ;;
  patch) patch=$((patch + 1)) ;;
  *) echo "Usage: release [major|minor|patch]"; exit 1 ;;
esac

new="$major.$minor.$patch"
echo "New version: $new"
echo ""

# Get commits since last tag
echo "Changes since v$current:"
commits=$(git log "v$current"..HEAD --pretty=format:"- %s" 2>/dev/null || git log --pretty=format:"- %s" -10)
echo "$commits"
echo ""

# Create temp file for changelog entry
tmpfile=$(mktemp)
today=$(date +%Y-%m-%d)
cat > "$tmpfile" << EOF
## [$new] - $today

### Changed
$commits

EOF

# Open editor for user to refine
echo "Opening editor to refine changelog..."
${EDITOR:-vim} "$tmpfile"

# Show what will be added
echo ""
echo "Changelog entry:"
cat "$tmpfile"
echo ""

# Confirm
read -p "Release v$new with this changelog? [y/N] " -n 1 -r
echo
[[ ! $REPLY =~ ^[Yy]$ ]] && rm "$tmpfile" && exit 0

# Update formula
sed -i '' "s/tag: \"v$current\"/tag: \"v$new\"/" Formula/claude-sessions.rb
sed -i '' "s/version \"$current\"/version \"$new\"/" Formula/claude-sessions.rb

# Update changelog - insert after line 7 (after the header)
changelog_entry=$(cat "$tmpfile")
rm "$tmpfile"

# Create new changelog with entry inserted
head -7 CHANGELOG.md > CHANGELOG.md.new
echo "" >> CHANGELOG.md.new
echo "$changelog_entry" >> CHANGELOG.md.new
tail -n +8 CHANGELOG.md >> CHANGELOG.md.new
mv CHANGELOG.md.new CHANGELOG.md

# Commit and tag
git add -A
git commit -m "release: v$new"
git tag "v$new"
git push && git push origin "v$new"

# Update tap
cp Formula/claude-sessions.rb ~/code/homebrew-tap/Formula/
cd ~/code/homebrew-tap
git add -A
git commit -m "bump: claude-sessions v$new"
git push

echo ""
echo "âœ“ Released v$new"
echo "  Users can upgrade with: brew upgrade claude-sessions"
