#!/usr/bin/env bash
set -e

CLAUDE_DIR="${CLAUDE_DIR:-$HOME/.claude}"
CACHE="$CLAUDE_DIR/sessions-cache.tsv"
PROJECTS="$CLAUDE_DIR/projects"

sid="$1"
[ -z "$sid" ] && echo "Usage: claude-sessions-branch <session-id>" >&2 && exit 1

# Find original session
original=$(find "$PROJECTS" -name "${sid}.jsonl" 2>/dev/null | head -1)
[ -z "$original" ] && echo "Session not found: $sid" >&2 && exit 1

# Extract project directory
proj_dir=$(dirname "$original")

# Generate new UUID
new_uuid=$(uuidgen | tr '[:upper:]' '[:lower:]')
new_file="$proj_dir/${new_uuid}.jsonl"

# Copy session file and update mtime to ensure it's picked up by incremental rebuild
cp "$original" "$new_file"
touch "$new_file"

# Add branch metadata to the new session file (prepend as first line)
branch_meta="{\"type\":\"branch\",\"parentSession\":\"$sid\",\"branchedAt\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}"
{
  echo "$branch_meta"
  cat "$new_file"
} > "$new_file.tmp"
mv "$new_file.tmp" "$new_file"

# Update cache inline
proj=$(basename "$proj_dir" | sed "s/-Users-[^-]*-code-//")
if [[ "$OSTYPE" == "darwin"* ]]; then
  date_str=$(stat -f "%Sm" -t "%m-%d" "$new_file")
  mtime=$(stat -f "%m" "$new_file")
else
  date_str=$(date -r "$new_file" "+%m-%d")
  mtime=$(stat -c "%Y" "$new_file")
fi
summary=$(head -c 50000 "$new_file" | grep -m1 -o '"summary":"[^"]*"' | sed 's/"summary":"//;s/"$//' || echo "-")

# Append to cache with parent_sid reference
printf '%s\t%s\t%s\t%s\t%s\t%s\n' "$new_uuid" "$date_str" "$proj" "$summary" "$mtime" "$sid" >> "$CACHE"

# Output the new session ID
echo "$new_uuid"
