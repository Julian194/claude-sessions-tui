#!/usr/bin/env bash
set -e

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

CLAUDE_DIR="${CLAUDE_DIR:-$HOME/.claude}"
CACHE="$CLAUDE_DIR/sessions-cache.tsv"

HEADER='enter=resume | ctrl-o=export | ctrl-y=copy-md | ctrl-b=branch | ctrl-r=refresh'
LOADING_HEADER='[Loading...] enter=resume | ctrl-o=export | ctrl-y=copy-md | ctrl-b=branch | ctrl-r=refresh'
FZF_PORT=$((10000 + RANDOM % 50000))

# Ensure cache exists
touch "$CACHE"

# Background: rebuild cache and reload with full formatting
(
  sleep 0.1  # Brief delay to ensure fzf is listening
  curl -s "localhost:$FZF_PORT" -d "reload($SCRIPT_DIR/claude-sessions-rebuild)+change-header($HEADER)" >/dev/null 2>&1
) &

# Start fzf immediately with cached data, background will reload with fresh data
result=$(fzf < "$CACHE" \
  --delimiter=$'\t' \
  --with-nth=2,3,4 \
  --ansi \
  --preview="$SCRIPT_DIR/claude-sessions-preview {1}" \
  --preview-window=right:50%:wrap \
  --header="$LOADING_HEADER" \
  --listen="localhost:$FZF_PORT" \
  --bind="ctrl-r:reload($SCRIPT_DIR/claude-sessions-rebuild)+change-header($HEADER)" \
  --bind="ctrl-y:execute-silent($SCRIPT_DIR/claude-sessions-copy-md {1} && $SCRIPT_DIR/claude-sessions-reset-header $FZF_PORT '$HEADER' &)+change-header(Copied to clipboard!)" \
  --bind="ctrl-o:execute-silent($SCRIPT_DIR/claude-sessions-export {1} && $SCRIPT_DIR/claude-sessions-reset-header $FZF_PORT '$HEADER' &)+change-header(Exported!)" \
  --expect=enter,ctrl-b)

key=$(echo "$result" | head -1)
line=$(echo "$result" | tail -n +2)

[ -z "$line" ] && exit 0

sid=$(echo "$line" | cut -f1)

# Ignore date headers - restart selection
if [ "$sid" = "---HEADER---" ]; then
  exec "$0"
fi

case "$key" in
  ctrl-b)
    # Branch session: create copy and resume the new one
    new_sid=$("$SCRIPT_DIR/claude-sessions-branch" "$sid")
    if [ -n "$new_sid" ]; then
      echo "Branched session: $new_sid"
      f=$(find "$CLAUDE_DIR/projects" -name "${new_sid}.jsonl" 2>/dev/null | head -1)
      cwd=$(grep -o '"cwd":"[^"]*"' "$f" 2>/dev/null | head -1 | sed 's/"cwd":"//g;s/"$//g')
      if [ -n "$cwd" ] && [ -d "$cwd" ]; then
        cd "$cwd" && claude --resume "$new_sid" --dangerously-skip-permissions
      else
        claude --resume "$new_sid" --dangerously-skip-permissions
      fi
    fi
    ;;
  *)
    # Default: resume selected session
    f=$(find "$CLAUDE_DIR/projects" -name "${sid}.jsonl" 2>/dev/null | head -1)
    cwd=$(grep -o '"cwd":"[^"]*"' "$f" 2>/dev/null | head -1 | sed 's/"cwd":"//g;s/"$//g')
    if [ -n "$cwd" ] && [ -d "$cwd" ]; then
      cd "$cwd" && claude --resume "$sid" --dangerously-skip-permissions
    else
      claude --resume "$sid" --dangerously-skip-permissions
    fi
    ;;
esac
