#!/usr/bin/env bash
set -e

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

CLAUDE_DIR="${CLAUDE_DIR:-$HOME/.claude}"
CACHE="$CLAUDE_DIR/sessions-cache.tsv"

# Always refresh cache on start (incremental update is very fast ~70ms)
# This ensures we always have fresh data without noticeable delay
"$SCRIPT_DIR/claude-sessions-rebuild" > /dev/null 2>&1

HEADER='enter=resume | ctrl-o=export | ctrl-y=copy-md | ctrl-r=refresh'
FZF_PORT=$((10000 + RANDOM % 50000))

result=$(fzf < "$CACHE" \
  --delimiter=$'\t' \
  --with-nth=2,3,4 \
  --preview="$SCRIPT_DIR/claude-sessions-preview {1}" \
  --preview-window=right:50%:wrap \
  --header="$HEADER" \
  --listen="localhost:$FZF_PORT" \
  --bind="ctrl-r:reload($SCRIPT_DIR/claude-sessions-rebuild)+change-header($HEADER)" \
  --bind="ctrl-y:execute-silent($SCRIPT_DIR/claude-sessions-copy-md {1} && $SCRIPT_DIR/claude-sessions-reset-header $FZF_PORT '$HEADER' &)+change-header(Copied to clipboard!)" \
  --bind="ctrl-o:execute-silent($SCRIPT_DIR/claude-sessions-export {1} && $SCRIPT_DIR/claude-sessions-reset-header $FZF_PORT '$HEADER' &)+change-header(Exported!)" \
  --expect=enter)

key=$(echo "$result" | head -1)
line=$(echo "$result" | tail -n +2)

[ -z "$line" ] && exit 0

sid=$(echo "$line" | cut -f1)

case "$key" in
  *)
    f=$(find "$CLAUDE_DIR/projects" -name "${sid}.jsonl" 2>/dev/null | head -1)
    cwd=$(grep -o '"cwd":"[^"]*"' "$f" 2>/dev/null | head -1 | sed 's/"cwd":"//g;s/"$//g')
    if [ -n "$cwd" ] && [ -d "$cwd" ]; then
      cd "$cwd" && claude --resume "$sid" --dangerously-skip-permissions
    else
      claude --resume "$sid" --dangerously-skip-permissions
    fi
    ;;
esac
