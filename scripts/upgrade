#!/usr/bin/env bash
set -e

echo "Updating homebrew..."
brew update --quiet 2>/dev/null || true

current=$(brew list --versions claude-sessions 2>/dev/null | awk '{print $2}')
if [ -z "$current" ]; then
  echo "claude-sessions is not installed. Install with:"
  echo "  brew install julian194/tap/claude-sessions"
  exit 1
fi

latest=$(brew info julian194/tap/claude-sessions 2>/dev/null | head -1 | awk '{print $4}' | tr -d ',')

if [ "$current" = "$latest" ]; then
  echo "claude-sessions is at version $current, rebuilding from source..."
else
  echo "Upgrading claude-sessions $current → $latest..."
fi

# Always build from source to avoid cached bottles
brew reinstall --build-from-source julian194/tap/claude-sessions 2>&1 || true

# Force link in case of conflicts
brew link --overwrite claude-sessions 2>/dev/null || true

echo ""
echo "✓ claude-sessions v$latest installed"
